<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoPontos Fortaleza</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body { background-color: #f4fdf6; }
        .card-header { background-color: #28a745; color: white; font-weight: bold; }
        button { background-color: #28a745; border: none; }
        .para { text-align: center;}
        button:hover { background-color: #218838; }
        #mapa { width: 100%; height: 400px; border-radius: 10px; margin-top: 20px; }
    </style>
</head>
<body>
<div class="container py-4">
    <h1 class="text-center mb-4" style="color:#28a745;">EcoPontos Fortaleza</h1>

    <div class="row">
        <!-- Pesquisa por ecopontos -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header">Pesquisar Pontos de Coleta no Mapa</div>
                <div class="card-body">
                    <div class="mb-3">
                        <input type="text" id="nomePesquisa" class="form-control" placeholder="Pesquisar por nome do ecoponto">
                    </div>
                    <p class="para">ou</p>
                    <div class="input-group mb-3">
                        <input type="text" id="bairroPesquisa" class="form-control" placeholder="Pesquisar por bairro">
                        <button class="btn" onclick="pesquisar()">Pesquisar</button>
                    </div>
                    <ul id="resultados" class="list-group"></ul>
                </div>
            </div>
        </div>

        <!-- Formulário de cadastro -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header">Conhece Algum Ponto de Coleta Não Cadastrado?</div>
                <div class="card-body">
                    <form id="formCadastro">
                        <div class="mb-3"><input type="text" id="nome" class="form-control" placeholder="Nome do ecoponto" required></div>
                        <div class="mb-3"><input type="text" id="endereco" class="form-control" placeholder="Endereço" required></div>
                        <div class="mb-3"><input type="text" id="bairro" class="form-control" placeholder="Bairro" required></div>
                        <div class="mb-3"><input type="text" id="cep" class="form-control" placeholder="CEP" required></div>
                        <button type="submit" class="btn w-100">Cadastrar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Mapa interativo -->
    <div class="card shadow-sm">
        <div class="card-header">Mapa de Fortaleza</div>
        <div class="card-body">
            <div id="mapa"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    // Inicializar mapa centrado em Fortaleza
    const mapa = L.map('mapa').setView([-3.71722, -38.52667], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(mapa);

    let markers = [];

    async function atualizarMapa(pontos) {
      // Limpar marcadores antigos
      markers.forEach(marker => mapa.removeLayer(marker));
      markers = [];

      pontos.forEach(ponto => {
        // Converter endereço em coordenadas usando API do OpenStreetMap Nominatim
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(ponto.endereco + ', ' + ponto.bairro + ', Fortaleza')}`)
          .then(res => res.json())
          .then(data => {
            if(data[0]) {
              const lat = parseFloat(data[0].lat);
              const lon = parseFloat(data[0].lon);
              const marker = L.marker([lat, lon]).addTo(mapa);
              marker.bindPopup(`<b>${ponto.nome}</b><br>${ponto.endereco} - ${ponto.bairro}<br>CEP: ${ponto.cep}<br>Coleta: ${ponto.coleta}`);
              markers.push(marker);
            }
          });
      });
    }

    // Cadastro de novo ponto
    document.getElementById("formCadastro").addEventListener("submit", async (e) => {
      e.preventDefault();

      const nome = document.getElementById("nome").value;
      const endereco = document.getElementById("endereco").value;
      const bairro = document.getElementById("bairro").value;
      const cep = document.getElementById("cep").value;


      const res = await fetch("http://localhost:3000/pontos", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nome, endereco, bairro, cep })
      });

      const data = await res.json();

      if(res.ok){
        alert("Ponto cadastrado com sucesso!");
        document.getElementById("formCadastro").reset();
        pesquisar(); // Atualiza lista e mapa automaticamente
      } else {
        alert("Erro: " + data.error);
      }
    });

    // Pesquisa por bairro ou nome
 async function pesquisar() {
  const bairro = document.getElementById("bairroPesquisa").value;
  const nome = document.getElementById("nomePesquisa").value;

  // Se nada foi digitado, não mostra nada
  if (!bairro && !nome) {
    document.getElementById("resultados").innerHTML = "";
    markers.forEach(marker => mapa.removeLayer(marker));
    markers = [];
    return;
  }

  let url = "http://localhost:3000/pontos?";
  if (bairro) url += `bairro=${bairro}&`;
  if (nome) url += `nome=${nome}&`;

  const res = await fetch(url);
  const pontos = await res.json();

  // Limpar resultados antigos
  const ul = document.getElementById("resultados");
  ul.innerHTML = "";

  // Limpar marcadores antigos
  markers.forEach(marker => mapa.removeLayer(marker));
  markers = [];

  // Mostrar apenas resultados da pesquisa
  if (pontos.length === 0) {
    ul.innerHTML = "<li class='list-group-item'>Nenhum ponto encontrado</li>";
    return;
  }

  pontos.forEach(ponto => {
    const li = document.createElement("li");
    li.className = "list-group-item";
    li.textContent = `${ponto.nome} - ${ponto.endereco} - ${ponto.bairro} - CEP: ${ponto.cep}`;
    ul.appendChild(li);

    // Adicionar marcador no mapa
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(ponto.endereco + ', ' + ponto.bairro + ', Fortaleza')}`)
      .then(res => res.json())
      .then(data => {
        if (data[0]) {
          const lat = parseFloat(data[0].lat);
          const lon = parseFloat(data[0].lon);
          const marker = L.marker([lat, lon]).addTo(mapa);
          marker.bindPopup(`<b>${ponto.nome}</b><br>${ponto.endereco} - ${ponto.bairro}<br>CEP: ${ponto.cep}`);
          markers.push(marker);
        }
      });
  });
}

    // Carregar todos os pontos ao iniciar
    pesquisar();
</script>
</body>
</html>